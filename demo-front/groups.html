<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
    <meta charset="utf-8" />
    <title>Compras comunitarias</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="" name="author" />
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet" type="text/css" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet" type="text/css" />
    <!-- END GLOBAL MANDATORY STYLES -->
    <!-- BEGIN THEME GLOBAL STYLES -->
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/css/components.min.css" rel="stylesheet" id="style_components" type="text/css" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/css/plugins.min.css" rel="stylesheet" type="text/css" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/pages/css/profile.min.css" rel="stylesheet" type="text/css" />
    <!-- END THEME GLOBAL STYLES -->
    <!-- BEGIN THEME LAYOUT STYLES -->
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/layouts/layout/css/layout.min.css" rel="stylesheet" type="text/css" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/layouts/layout/css/themes/darkblue.min.css" rel="stylesheet" type="text/css" id="style_color" />
    <link href="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/layouts/layout/css/custom.min.css" rel="stylesheet" type="text/css" />
    <!-- END THEME LAYOUT STYLES -->
    <link rel="shortcut icon" href="favicon.ico" /> </head>
    <!-- Spanish -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!--Fontawesome -->
    <link rel="stylesheet" href="./assets/fontawesome-free-5.0.13/web-fonts-with-css/css/fontawesome-all.css">
   
</head>
<!-- END HEAD -->

<style type="text/css">

    body {
        background-color: white;
    }

    .Titulo-navs {
        font-family: 'Oswald', sans-serif;
        font-size: 14px;
        color: #98999D;
    }

    .white-bar-small { 
        padding-top: 2.5rem;
     }

    .page-header.navbar {
        background-color: white;
    }

    .nav-tabs {
        border-bottom-width: 0px !important;
        padding-top: 1.5rem !important;
        padding-left: 10.5rem !important;
        border: 0px !important;
    }
    
    .nav > li > a {
        position: relative !important;
        display: block !important;
        padding-top: 0.1rem !important;
        border: 0px !important;
    }

    ul.nav > li > a:hover {
        background-color: #FFFFFF !important;
        color: #000000 !important;
        border-style: none !important;
        font-size: 16px !important;
        border: 0px !important;
    }
    
    ul.nav > li > a:focus {
        background-color: #FFFFFF !important;
        color: #000000 !important;
        border-style: none !important;
        font-size: 16px !important;
        border: 0px !important;
    }

    .element-step {
        font-size: 23px;
        border-radius: 50% !important;
        float: left;
        margin: auto;
        margin-top: auto;
        margin-right: auto;
        margin-bottom: auto;
        margin-left: auto;
        padding: 3px 14px;
        padding-top: 3px;
        padding-right: 14px;
        padding-bottom: 3px;
        padding-left: 14px;
    }

    .btn.btn-outline.green {
        border-color: #2AB4C0;
        color: #FFFFFF;
        background-color: #2AB4C0;
    }
    .btn.btn-outline.green:hover {
        border-color: #2AB4C0;
        color: #2AB4C0;
        background: 0 0;
    }

    .btn.btn-outline.pink {
        border-color: #E7505A;
        color: #E7505A;
        background: 0 0;
    }
    .btn.btn-outline.pink:hover {
        border-color: #E7505A;
        color: #FFFFFF;
        background-color: #E7505A;
    }

    .btn:hover, .btn:focus, .btn.focus {
        color: #333;
        text-decoration: none;
    }

    .modal-dialog{
        overflow-y: initial !important
    }
    .modal-body{
        height: 350px;
        overflow-y: auto;
    }
    .panel-body {
        padding: 3px;
    }

</style>

<body>

    <div class="page-header navbar navbar-fixed-top">
        <div class="col-md-12">
            <div class="col-md-3">
                <div class="col-md-1"></div>
                <a href="#"><i class="fas fa-shopping-cart fa-3x" style="padding-top: 1.5rem; color: #2AB4C0;"></i></a>
            </div>
            <div class="col-md-8" style="height:90px;">
                <ul class="nav nav-tabs ">
                    <li class="">
                      <a class="Titulo-navs" href="./profile.html" aria-expanded="false">
                      PERFIL </a>
                    </li>
                    <li class="">
                      <a class="Titulo-navs" href="./createOrder.html" aria-expanded="false">
                      LISTA DE COMPRAS</a>
                    </li>
                    <li class="active">
                      <a class="Titulo-navs" href="#" aria-expanded="true">
                      GRUPOS</a>
                    </li>
                    <li class="">
                      <a class="Titulo-navs" href="./login.html" aria-expanded="false">
                      CERRAR SESIÓN </a>
                    </li>
                  </ul>
            </div>
        </div>
    </div>

    <div class="white-bar-small"></div>
    <div class="row"  style="padding-top:90px;">
        <div class="col-md-12" style="padding-bottom:0rem; background-color:#2AB4C0;">
            <div class="col-md-12">
                <div style="font-family: 'Playfair Display', sans-serif;font-size: 16px; color:white;text-align: left; padding-top:3.5rem; padding-bottom:3.5rem; padding-left:8.5rem"> GRUPOS </div>
            </div>
        </div>
    </div>

    <div class="col-md-12">
        <div class="col-md-4">
        <div class="white-bar-small" style="padding-bottom: 3rem;"></div>
            <div class="portlet-body">
                <div class="mt-element-list">
                    <div class="mt-list-head list-simple font-white bg-red">
                        <div class="list-head-title-container">
                            <h3 class="list-title">Mis grupos</h3>
                        </div>
                    </div>
                    <div class="mt-list-container list-simple">
                        <ul id="l_groupList">
 
                        </ul>
                    </div>
                    <div class="white-bar-small" style="padding-bottom: 1rem;"></div>
                    <div class="wrapper" style="text-align: center;">
                        <button type="button" class="btn pink btn-outline btn-lg" onclick="javascript: abirCrearGrupo()">CREAR GRUPO</button>
                    </div>
                </div>
            </div>
                                        
        </div>
        <div class="col-md-8">
            <div class="white-bar-small" style="padding-bottom: 3rem;"></div>
            <div class="portlet box purple">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fas fa-bars"></i>Pedido del grupo </div>
                    <div class="tools">
                        <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>
                        <a href="#" class="reload" data-original-title="" title=""> </a>
                        <a href="javascript:;" class="remove" data-original-title="" title=""> </a>
                    </div>
                </div>
                <div class="portlet-body" id="p_tables">
                    
                </div>
            </div>
        
        </div>

        <div id="modal_grupo" class="modal fade in" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title">Información del grupo</h4>
                    </div>
                    <div class="modal-body">
                        <div class="slimScrollDiv" style="position: relative; overflow: hidden; width: auto; height: 300px;"><div class="scroller" style="height: 300px; overflow: hidden; width: auto;" data-always-visible="1" data-rail-visible1="1" data-initialized="1">
                            <div class="col-md-12">
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Nombre</h3>
                                    </div>
                                    <div class="panel-body" id="g_nombre"> </div>
                                </div>
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Administrador</h3>
                                    </div>
                                    <div class="panel-body" id="g_administrador"> </div>
                                </div>
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Miembros</h3>
                                    </div>
                                    <div class="panel-body" id="g_miembros"> </div>
                                </div>
                            </div>
                        </div><div class="slimScrollBar" style="background: rgb(187, 187, 187) none repeat scroll 0% 0%; width: 7px; position: absolute; top: 0px; opacity: 0.4; display: none; border-radius: 7px; z-index: 99; right: 1px; height: 300px;"></div><div class="slimScrollRail" style="width: 7px; height: 100%; position: absolute; top: 0px; display: none; border-radius: 7px; background: rgb(234, 234, 234) none repeat scroll 0% 0%; opacity: 0.2; z-index: 90; right: 1px;"></div></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" data-dismiss="modal" class="btn dark btn-outline">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal_Nuevogrupo" class="modal fade in" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title">Nuevo Grupo</h4>
                    </div>
                    <div class="modal-body">


                    </div>
                    <div class="modal-footer">
                        <button type="button" data-dismiss="modal" class="btn dark btn-outline">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
                                
                                    
    <!--Google Maps -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhnMYzus4S7e-uYtr3aKCO2eImUtVsXu8"></script>
    <!-- BEGIN CORE PLUGINS -->
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/jquery.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/js.cookie.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
    <!-- END CORE PLUGINS -->
    <!-- BEGIN THEME GLOBAL SCRIPTS -->
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/global/scripts/app.min.js" type="text/javascript"></script>
    <!-- END THEME GLOBAL SCRIPTS -->
    <!-- BEGIN THEME LAYOUT SCRIPTS -->
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/layouts/layout/scripts/layout.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/layouts/layout/scripts/demo.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/layouts/global/scripts/quick-sidebar.min.js" type="text/javascript"></script>
    <script src="./assets/metronic_v5.2.1/metronic_v4.7.5/theme/assets/layouts/global/scripts/quick-nav.min.js" type="text/javascript"></script>
    <!-- END THEME LAYOUT SCRIPTS -->
    

    <script type="text/javascript">
        jQuery(document).ready(function () {
            getGroups();
        });

        function getGroups() {
            var url = "http://localhost:3000/api";
            var token = localStorage.getItem("token")

            jQuery.ajax({
                type:"get",
                url: url + '/groups',
                data: JSON.stringify({}),
                contentType: 'application/json',
                xhrFields: {
                    withCredentials: true
                },
                headers: {
                    'Authorization': token
                },
                success: function(data) {
                    cargarGrupos(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert(textStatus);
                }
            });
        }

        function cargarGrupos (data) {
            var l_groupList, admin, members;
            var products;

            l_groupList = document.getElementById('l_groupList');
            for(i = 0; i < data.length; i++) {
                products = [];
                members = '';

                admin = data[i].fullMembers[0].username;

                for(j = 0; j < data[i].fullMembers.length; j++) {
                    members = members + data[i].fullMembers[j].username + ' - ';
                    products.push(data[i].fullMembers[j].products);
                }
                members = members.substring(0, members.length-2);
                
                l_groupList.innerHTML = l_groupList.innerHTML + "<li class=\"mt-list-item\"><div class=\"list-icon-container done\"><i class=\"fas fa-users\"></i></div><div class=\"list-datetime\"> <a href=\"javascript:abrirDatosGrupo('" + data[i].name + "','" + admin + "','" + members + "');\" class=\"btn btn-sm red\"> info <i class=\"fas fa-info-circle\"></i></a></div><div class=\"list-item-content\"><h3 class=\"uppercase\"><a href=\"javascript:mostrarPedidosGrupo(" + i + ");\">" + data[i].name + "</a></h3></div></li>";
                armarTablaPedidos(products, i);
                
            }
        }

        function armarTablaPedidos(products, number) {
            var product, productName, codigo, quantity, i, j;
            var p_tables = document.getElementById('p_tables');
            var content = "";
            var dict_prod = {};
            var counter = 0;
            var productName = "Nombre del producto";

            for(i = 0; i < products.length; i++) {
                product = products[i];
                for(j = 0; j < product.length; j++) {
                    codigo = product[j].product;
                    quantity = product[j].quantity;
                    if (codigo in dict_prod) {
                        dict_prod[codigo] = dict_prod[codigo] + quantity;
                    }
                    else {
                        dict_prod[codigo] = quantity;
                    }
                }
            }

            for (var key in dict_prod){
                counter = counter + 1;
                content = content + "<tr><td>" + counter + "</td><td> " + key + " </td><td> " + productName + " </td><td> " + dict_prod[key] + " </td></tr>";
            }

            p_tables.innerHTML = p_tables.innerHTML + "<div class=\"groupsOrder\" style=\"display:none; \" id=\"t_grupo_" + number + "\" class=\"table-responsive\"><table class=\"table table-striped table-bordered table-hover\"><thead><tr><th> # </th><th> Código Producto </th><th> Nombre </th><th> Cantidad </th></tr></thead><tbody>" + content + "</tbody></table></div>";
        }


        function abrirDatosGrupo(nombre, administrador, miembros) {

            var g_nombre = document.getElementById('g_nombre');
            var g_administrador = document.getElementById('g_administrador');
            var g_miembros = document.getElementById('g_miembros');

            g_nombre.innerHTML = nombre;
            g_administrador.innerHTML = administrador;
            g_miembros.innerHTML = miembros;
            
            $("#modal_grupo").modal();
        }

        function mostrarPedidosGrupo(number) {
            var tableName = 't_grupo_' + number.toString();
            var allTables = document.getElementsByClassName('groupsOrder');
            var t_grupo = document.getElementById(tableName);
    
            for (i = 0; i < allTables.length; i++) {
                allTables[i].style.display = 'none';
            }

            t_grupo.style.display = 'block';
        }

        function abirCrearGrupo() {
            $("#modal_Nuevogrupo").modal();
        }

        function obtenerNombreUsuario(id) {
            var url = "http://localhost:3000/api";

            jQuery.ajax({
                type:"get",
                url: url + '/auth/profile',
                data: JSON.stringify({}),
                contentType: 'application/json',
                xhrFields: {
                    withCredentials: true
                },
                headers: {
                    'Authorization': id
                },
                success: function(data) {
                    return data.username;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    return '';
                }
            });

        }


    </script>

</html>